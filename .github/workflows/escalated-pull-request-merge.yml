name: Escalated Pull Request Merge
# Merge actions kicked off by probot (https://github.com/SentientTechnologies/probot)
# This allows PRs from forked repos to run actions that require values from secrets when a team member merges

on:
  repository_dispatch:
    types: [escalated-pull-request-merge-command]

jobs:
  tag:
    name: Tag Build
    runs-on: ubuntu-latest
    steps:
      - name: Set up Node
        uses: actions/setup-node@v1
        with:
          node-version: '13'
      - name: Checkout Ref
        uses: actions/checkout@v1
        with:
          ref: ${{ github.event.client_payload.ref }}
      - name: Set Up Variables
        id: variables
        run: |
          export EMPTY_STRING=""
          echo ::set-output name=MAJOR::$(node -p "re = new RegExp('^(\\\d+).(\\\d+).(\\\d+)'); v = require('./package.json').version; re.exec(v)[1]")
          echo ::set-output name=MINOR::$(node -p "re = new RegExp('^(\\\d+).(\\\d+).(\\\d+)'); v = require('./package.json').version; re.exec(v)[2]")
        env:
          NPM_TOKEN: ""
      - name: Bump n Tag
        if: github.event.client_payload.ref == 'master'
        uses: evolv-ai/github-actions/semver-bump-tag@v4
        id: semver_bump
        with:
          token: "${{ github.token }}"
          major: ${{steps.variables.outputs.MAJOR}}
          minor: ${{steps.variables.outputs.MINOR}}
          bump: patch
          suffix: "test" # TODO delete this once ready
# TODO allow this to run and test against this to see if we have the right info in the cherry picker
#      - name: Cherry Picker
#        if: github.event.client_payload.ref == 'master'
#        uses: evolv-ai/github-actions/cherry-picker@v6
#        id: cherry-picker
#        with:
#          token: "${{ secrets.GH_TOKEN }}"
#          pull_number: ${{ github.event.pull_request.number }}
#          slack_webhook: ${{ secrets.CHERRY_PICK_SLACK_WEBHOOK }}
